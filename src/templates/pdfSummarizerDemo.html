<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Backends - PDF Summarization Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-purple': '#B341F9',
            'brand-pink': '#E453C0',
            'terminal-bg': '#1C2128',
            'terminal-text': '#A7B5C4'
          },
          backgroundImage: {
            'gradient-brand': 'linear-gradient(135deg, #B341F9, #E453C0)',
          }
        }
      }
    }
  </script>
  <style>
    .metrics-container {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
    }
    .metric-item {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .metric-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .metric-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }
    .metric-value {
      font-size: 14px;
      font-weight: 600;
    }
    /* Markdown styling */
    .md-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .md-table thead {
      background: #f9fafb;
    }
    .md-table th {
      text-align: left;
      padding: 12px;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
    }
    .md-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .md-table tbody tr:hover {
      background: #f9fafb;
    }
    .md-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    /* Fullscreen styles for maximize mode */
    .fullscreen-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease-in-out;
    }
    .fullscreen-backdrop.active {
      opacity: 1;
      pointer-events: auto;
    }
    .fullscreen-output {
      position: fixed !important;
      inset: 4% 4% auto 4% !important;
      max-height: 92% !important;
      width: auto !important;
      z-index: 9999 !important;
      background: white !important;
      box-shadow: 0 20px 50px rgba(0,0,0,0.25);
    }
    .fullscreen-output .fullscreen-inner {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .fullscreen-output .fullscreen-body {
      flex: 1 1 auto;
      overflow: auto;
      height: auto;
      padding-right: 4px;
    }
    .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border: 1px solid #e5e7eb;
      color: #374151;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 10;
    }
    .close-button:hover {
      background: #f9fafb;
    }
    /* Hide maximize button when in fullscreen; exit with X button */
    .fullscreen-output #fullscreenButton {
      display: none !important;
    }
  </style>
  <script src="/api/shared/safedom.js"></script>
</head>
<body class="bg-white min-h-screen">
  <!-- Navigation -->
  <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg border-b border-gray-100">
    <div class="container mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <a href="/" class="flex items-center space-x-2">
          <div class="w-10 h-10 rounded-xl bg-[#B341F9] flex items-center justify-center">
            <span class="text-white font-bold text-xl">AI</span>
          </div>
          <span class="text-2xl font-bold text-gray-900">Backends</span>
          <span class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-50 text-green-700">
            <svg class="w-4 h-4 mr-1" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z"/>
            </svg>
            Open Source
          </span>
        </a>
        <div class="flex items-center space-x-6">
          <a href="/api/ui" target="_blank" class="text-gray-700 hover:text-brand-purple transition-colors duration-300">API Docs</a>
          <a href="/api/demos" class="text-gray-700 hover:text-brand-purple transition-colors duration-300">Demos</a>
          <a href="/api/jsoneditor" target="_blank" class="text-gray-700 hover:text-brand-purple transition-colors duration-300">JSON Editor</a>
          <a href="/api/models" class="text-gray-700 hover:text-brand-purple transition-colors duration-300">Models Guide</a>
          <a href="https://github.com/donvito/ai-backend" class="inline-flex items-center px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors duration-300">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 0C4.477 0 0 4.484 0 10.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z" clip-rule="evenodd"/>
            </svg>
            GitHub
          </a>
        </div>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-6 py-12">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
      <ol class="flex items-center space-x-2 text-gray-500">
        <li><a href="/" class="hover:text-gray-700">Home</a></li>
        <li><span>/</span></li>
        <li><a href="/api/demos" class="hover:text-gray-700">Demos</a></li>
        <li><span>/</span></li>
        <li class="text-gray-900 font-medium">PDF Summarization</li>
      </ol>
    </nav>

    <!-- Demo Title and Description -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-3">PDF Summarization Demo</h1>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Extract and summarize content from PDF documents using AI models
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
      <!-- Controls -->
      <section class="bg-white p-6 rounded-2xl border border-gray-100 shadow-lg hover:shadow-xl transition-shadow duration-300">
        <h2 class="text-lg font-semibold mb-3">Input</h2>
        <label class="block text-sm font-medium text-gray-700 mb-1">PDF URL</label>
        <input id="pdfUrl" type="url" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple bg-white" placeholder="https://example.com/document.pdf" />

        <div class="grid grid-cols-2 gap-3 mt-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Max Words</label>
            <input id="maxLength" type="number" min="0" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple" value="200" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Temperature</label>
            <input id="temperature" type="number" step="0.1" min="0" max="1" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple" value="0.2" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Provider</label>
            <select id="provider" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple">
              <option value="ollama">ollama</option>
              <option value="openai">openai</option>
              <option value="openrouter">openrouter</option>
              <option value="lmstudio">lmstudio</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
            <select id="model" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple"></select>
          </div>
        </div>

        <div class="mt-3 flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input id="streaming" type="checkbox" class="w-4 h-4 text-brand-purple rounded focus:ring-2 focus:ring-brand-purple" checked />
            <span class="text-sm font-medium text-gray-700">Enable Streaming</span>
          </label>
        </div>

        <div class="mt-3">
          <label class="block text-sm font-medium text-gray-700 mb-1">Bearer Token (optional)</label>
          <input id="token" type="password" placeholder="Only needed in production deployments" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple" />
        </div>

        <div class="mt-4 flex items-center gap-2">
          <button id="runBtn" class="px-4 py-2 rounded-lg bg-brand-purple text-white hover:bg-[#9935D9]">Summarize PDF</button>
          <button id="cancelBtn" class="hidden px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Cancel</button>
          <button id="loadSample" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200">Load Sample</button>
        </div>

        <details class="mt-4">
          <summary class="text-sm text-gray-600 cursor-pointer">View JSON request</summary>
          <pre id="jsonPreview" class="mt-2 bg-gray-900 text-green-400 p-3 rounded-lg text-xs mono overflow-auto"></pre>
        </details>
      </section>

      <!-- Output -->
      <section id="outputPanel" class="bg-white p-6 rounded-2xl border border-gray-100 shadow-lg hover:shadow-xl transition-shadow duration-300">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-lg font-semibold">Output</h2>
          <div class="flex items-center gap-2">
            <button id="copyButton" onclick="copyOutput()" class="hidden inline-flex items-center px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg border border-gray-200 hover:bg-gray-200 transition-colors" title="Copy Output">
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
              </svg>
              Copy
            </button>
            <button id="fullscreenButton" onclick="toggleOutputFullscreen()" class="hidden inline-flex items-center px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg border border-gray-200 hover:bg-gray-200 transition-colors" title="Maximize Output">
              ⛶ Maximize
            </button>
          </div>
        </div>
        <div id="usageInfo" class="hidden mb-3 text-sm"></div>
        <div id="pdfMetadata" class="hidden mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm"></div>
        
        <!-- Loading State -->
        <div id="loadingState" class="hidden">
          <div class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-purple"></div>
          </div>
          <p class="text-center text-gray-500 mt-4">Processing PDF and generating summary...</p>
        </div>
        
        <div id="summaryText" class="p-4 rounded-lg bg-gray-50 border border-gray-200 leading-7 text-gray-900"></div>
      </section>
    </div>
  </main>

  <script>
    const samplePayload = {
      payload: {
        url: "https://arxiv.org/pdf/2506.02153",
        maxLength: 150
      },
      config: {
        provider: "ollama",
        model: "gemma3:4b",
        temperature: 0,
        stream: true
      }
    };

    const pdfUrlEl = document.getElementById('pdfUrl');
    const maxLengthEl = document.getElementById('maxLength');
    const temperatureEl = document.getElementById('temperature');
    const providerEl = document.getElementById('provider');
    const modelEl = document.getElementById('model');
    const tokenEl = document.getElementById('token');
    const streamingEl = document.getElementById('streaming');
    const runBtn = document.getElementById('runBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const loadSampleBtn = document.getElementById('loadSample');
    const summaryText = document.getElementById('summaryText');
    const usageInfo = document.getElementById('usageInfo');
    const pdfMetadata = document.getElementById('pdfMetadata');
    const jsonPreview = document.getElementById('jsonPreview');
    const loadingState = document.getElementById('loadingState');
    const outputPanel = document.getElementById('outputPanel');
    const copyButton = document.getElementById('copyButton');
    const fullscreenButton = document.getElementById('fullscreenButton');

    let abortController = null;
    let eventSource = null;

    // Dynamic model options fetched from backend (pdf-summarizer capability)
    let modelOptions = null;

    // Basic Markdown renderer (safe: escapes HTML first)
    function renderMarkdownSimple(md) {
      if (!md) return '';
      let s = escapeHtml(String(md));

      // Tables: detect header + separator + rows
      s = s.replace(/(^|\n)(\|.*\|)\n(\|?\s*:?-{3,}:?\s*(\|\s*:?-{3,}:?\s*)+\|?)\n([\s\S]*?)(\n{2,}|$)/g, (m, pfx, header, sep, _g, body, tail) => {
        const split = line => line.trim().replace(/^\|/, '').replace(/\|$/, '').split(/\s*\|\s*/);
        const headers = split(header);
        const aligns = split(sep).map(c => {
          const t = c.trim();
          const left = t.startsWith(':');
          const right = t.endsWith(':');
          if (left && right) return 'center';
          if (right) return 'right';
          if (left) return 'left';
          return 'left';
        });
        const rows = [];
        body.split('\n').forEach(line => {
          if (line.trim().startsWith('|')) rows.push(split(line));
        });
        let html = '<table class="md-table"><thead><tr>' + headers.map((h, i) => `<th style="text-align:${aligns[i] || 'left'}">${h}</th>`).join('') + '</tr></thead>';
        if (rows.length) {
          html += '<tbody>' + rows.map(r => '<tr>' + r.map((c, i) => `<td style="text-align:${aligns[i] || 'left'}">${c}</td>`).join('') + '</tr>').join('') + '</tbody>';
        }
        html += '</table>';
        return (pfx || '\n') + html + (tail || '\n');
      });

      // Code blocks: ```lang\ncode\n```
      s = s.replace(/```([\s\S]*?)```/g, (m, p1) => {
        const code = p1.replace(/^\w+\n/, '');
        return `<pre class="bg-gray-900 text-gray-100 rounded-lg p-3 overflow-auto"><code>${code}</code></pre>`;
      });

      // Headings
      s = s
        .replace(/^# (.+)$/gm, '<h2 class="text-2xl font-bold text-gray-900 mt-4 mb-2">$1</h2>')
        .replace(/^## (.+)$/gm, '<h3 class="text-xl font-semibold text-gray-800 mt-3 mb-2">$1</h3>')
        .replace(/^### (.+)$/gm, '<h4 class="text-lg font-medium text-gray-700 mt-2 mb-2">$1</h4>');

      // Bold and italics
      s = s.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold">$1</strong>');
      s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');

      // Inline code
      s = s.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 py-0.5 rounded text-gray-800">$1</code>');

      // Lists to <li>
      s = s
        .replace(/^\* (.+)$/gm, '<li class="ml-4 mb-1">$1</li>')
        .replace(/^- (.+)$/gm, '<li class="ml-4 mb-1">$1</li>')
        .replace(/^\d+\. (.+)$/gm, '<li class="ml-4 mb-1">$1</li>');
      // Wrap list groups with <ul>
      s = s
        .replace(/^<li/gm, '<ul class="list-disc list-inside mb-3">\n<li')
        .replace(/<\/li>\n(?!<li)/g, '</li></ul>');

      // Paragraphs: keep pre, ul, headings intact; wrap others
      const blocks = s.split(/\n{2,}/);
      s = blocks.map(block => {
        const b = block.trim();
        if (!b) return '';
        if (b.startsWith('<pre') || b.startsWith('<ul') || b.startsWith('<h2') || b.startsWith('<h3') || b.startsWith('<h4')) {
          return b;
        }
        return '<p class="mb-3">' + b.replace(/\n/g, '<br />') + '</p>';
      }).join('\n');

      return s;
    }

    // Fallback options if fetch fails or endpoint is unavailable
    const fallbackModelOptions = {
      ollama: [
        { value: 'gemma3:4b', label: 'gemma3:4b (default)' }
      ],
      openai: [
        { value: 'gpt-4o-mini', label: 'gpt-4o-mini' },
        { value: 'gpt-4.1-nano', label: 'gpt-4.1-nano' },
        { value: 'gpt-5-nano', label: 'gpt-5-nano' }
      ],
      openrouter: [
        { value: 'openai/gpt-4o-mini', label: 'openai/gpt-4o-mini' }
      ],
      lmstudio: [
        { value: 'gemma-3-270m-it', label: 'gemma-3-270m-it' },
        { value: 'llama-3.2-3b-instruct', label: 'llama-3.2-3b-instruct' }
      ]
    };

    function updateModelOptions() {
      const provider = providerEl.value;
      const source = modelOptions || fallbackModelOptions;
      const models = (source && source[provider]) ? source[provider] : [];
      setContent(modelEl, createOptions(models));
      updatePreview();
    }

    async function fetchPdfSummarizerModels() {
      const headers = {};
      const token = tokenEl.value.trim();
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch('/api/v1/services/models?source=config&view=capability', { headers });
      if (!res.ok) throw new Error('Failed to load models: ' + res.status);
      const data = await res.json();
      const pdfSummarizer = data && data.byCapability && data.byCapability['pdf-summarizer'];
      if (!pdfSummarizer || typeof pdfSummarizer !== 'object') throw new Error('Invalid models response');
      const mapped = {};
      for (const provider in pdfSummarizer) {
        const list = Array.isArray(pdfSummarizer[provider]) ? pdfSummarizer[provider] : [];
        mapped[provider] = list.map(name => ({ value: name, label: name }));
      }
      return mapped;
    }

    async function initModels() {
      try {
        modelOptions = await fetchPdfSummarizerModels();
      } catch (e) {
        modelOptions = null; // fall back to static options
      }
      const source = modelOptions || fallbackModelOptions;
      const providers = Object.keys(source);
      setContent(providerEl, createOptions(providers.map(p => ({ value: p, label: p }))));
      if (!providers.includes(providerEl.value)) {
        providerEl.value = providers[0] || '';
      }
      updateModelOptions();
    }

    function buildRequest() {
      return {
        payload: {
          url: pdfUrlEl.value.trim(),
          maxLength: Math.max(0, Number(maxLengthEl.value) || 0)
        },
        config: {
          provider: providerEl.value,
          model: modelEl.value,
          temperature: Number(temperatureEl.value) || 0,
          stream: streamingEl.checked
        }
      };
    }

    function updatePreview() {
      const req = buildRequest();
      jsonPreview.textContent = JSON.stringify(req, null, 2);
    }

    function setFromSample() {
      pdfUrlEl.value = samplePayload.payload.url;
      maxLengthEl.value = samplePayload.payload.maxLength || 200;
      streamingEl.checked = samplePayload.config.stream !== false;
      providerEl.value = 'ollama';
      updateModelOptions();
      modelEl.value = 'gemma3:4b';
      temperatureEl.value = samplePayload.config.temperature || 0;
      updatePreview();
    }

    async function run() {
      // Exit fullscreen if active
      if (isFullscreen) {
        exitFullscreen();
      }
      
      const req = buildRequest();
      updatePreview();
      const headers = { 'Content-Type': 'application/json' };
      const token = tokenEl.value.trim();
      if (token) headers['Authorization'] = 'Bearer ' + token;

      abortController = new AbortController();

      runBtn.classList.add('hidden');
      cancelBtn.classList.remove('hidden');

      // Clear previous content and show loading state
      summaryText.innerHTML = '';
      summaryText.classList.add('hidden');
      
      // Clear and hide other elements
      usageInfo.classList.add('hidden');
      pdfMetadata.classList.add('hidden');
      setContent(usageInfo, '');
      setContent(pdfMetadata, '');
      
      // Hide copy and maximize buttons
      copyButton.classList.add('hidden');
      fullscreenButton.classList.add('hidden');
      
      // Show loading state after clearing everything
      loadingState.classList.remove('hidden');

      const startTime = performance.now();

      try {
        if (req.config.stream) {
          // Streaming mode using Server-Sent Events
          const response = await fetch('/api/v1/pdf-summarizer', {
            method: 'POST',
            headers,
            body: JSON.stringify(req),
            signal: abortController.signal
          });

          if (!response.ok) {
            const txt = await response.text();
            throw new Error('Request failed: ' + response.status + ' ' + txt);
          }

          // Check if we got SSE content type
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('text/event-stream')) {
            // Fallback to non-streaming if server didn't return SSE
            const data = await response.json();
            const summary = data?.summary || data?.data?.summary || '';
            
            // Hide loading state and show summary
            loadingState.classList.add('hidden');
            summaryText.classList.remove('hidden');
            summaryText.innerHTML = summary ? renderMarkdownSimple(summary) : 'No summary returned.';
            
            // Show copy and maximize buttons if there's content
            if (summary) {
              copyButton.classList.remove('hidden');
              fullscreenButton.classList.remove('hidden');
            }
            
            // Display PDF metadata if available
            const metadata = data?.pdfMetadata || data?.data?.pdfMetadata;
            if (metadata) {
              displayPdfMetadata(metadata);
            }
            
            const endTime = performance.now();
            const responseTime = (endTime - startTime).toFixed(2);
            const usage = data?.usage || data?.data?.usage;
            if (usage) {
              displayUsageMetrics(usage, responseTime);
            }
            return;
          }

          // Keep loading state visible until first chunk arrives
          let accumulatedText = '';
          let usage = null;
          let metadata = null;
          let firstChunkReceived = false;

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';

            for (const line of lines) {
              if (line.trim().startsWith('data:')) {
                const data = line.replace(/^data:\s*/, '');
                if (data.trim() === '[DONE]' || data.trim() === '') {
                  continue;
                }
                try {
                  const parsed = JSON.parse(data);
                  if (parsed.chunk) {
                    // Hide loading state and show content on first chunk
                    if (!firstChunkReceived) {
                      firstChunkReceived = true;
                      loadingState.classList.add('hidden');
                      summaryText.classList.remove('hidden');
                      
                      // Show copy and maximize buttons
                      copyButton.classList.remove('hidden');
                      fullscreenButton.classList.remove('hidden');
                    }
                    
                    accumulatedText += parsed.chunk;
                    summaryText.innerHTML = renderMarkdownSimple(accumulatedText);
                  }
                  if (parsed.done && parsed.usage) {
                    usage = parsed.usage;
                  }
                  if (parsed.done && parsed.metadata) {
                    metadata = parsed.metadata;
                  }
                  if (parsed.error) {
                    throw new Error(parsed.error);
                  }
                } catch (e) {
                  if (e instanceof SyntaxError) {
                    console.warn('Failed to parse SSE data:', data);
                  } else {
                    throw e;
                  }
                }
              }
            }
          }

          const endTime = performance.now();
          const responseTime = (endTime - startTime).toFixed(2);

          // If no chunks were received, hide loading state and show empty message
          if (!firstChunkReceived) {
            loadingState.classList.add('hidden');
            summaryText.classList.remove('hidden');
            summaryText.innerHTML = '<span class="text-gray-500">No summary was generated.</span>';
          }

          // Display PDF metadata if available
          if (metadata) {
            displayPdfMetadata(metadata);
          }

          // Display usage metrics if available
          if (usage) {
            displayUsageMetrics(usage, responseTime);
          } else {
            // If no usage data in stream, just show response time
            usageInfo.classList.remove('hidden');
            let metricsHtml = '<div class="metrics-container">';
            metricsHtml += '<div class="grid grid-cols-1 gap-3">';
            metricsHtml += '<div class="metric-item">' +
              '<div class="metric-icon">' +
                '<svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                  '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
                '</svg>' +
              '</div>' +
              '<div>' +
                '<div class="metric-label">Response</div>' +
                '<div class="metric-value text-orange-600">' + responseTime + ' ms</div>' +
              '</div>' +
            '</div>';
            metricsHtml += '</div></div>';
            const metricsDiv = createElement('div');
            metricsDiv.innerHTML = metricsHtml;
            setContent(usageInfo, metricsDiv.firstChild);
          }
        } else {
          // Non-streaming mode (original implementation)
          const res = await fetch('/api/v1/pdf-summarizer', {
            method: 'POST',
            headers,
            body: JSON.stringify(req),
            signal: abortController.signal
          });
          const endTime = performance.now();
          const responseTime = (endTime - startTime).toFixed(2);
          
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Request failed: ' + res.status + ' ' + txt);
          }
          const data = await res.json();
          const summary = data?.summary || data?.data?.summary || '';
          
          // Hide loading state and show summary
          loadingState.classList.add('hidden');
          summaryText.classList.remove('hidden');
          summaryText.innerHTML = summary ? renderMarkdownSimple(summary) : 'No summary returned.';
          
          // Show copy and maximize buttons if there's content
          if (summary) {
            copyButton.classList.remove('hidden');
            fullscreenButton.classList.remove('hidden');
          }

          // Display PDF metadata if available
          const metadata = data?.pdfMetadata || data?.data?.pdfMetadata;
          if (metadata) {
            displayPdfMetadata(metadata);
          }

          const usage = data?.usage || data?.data?.usage;
          if (usage) {
            displayUsageMetrics(usage, responseTime);
          }
        }
      } catch (err) {
        // Hide loading state and show error
        loadingState.classList.add('hidden');
        summaryText.classList.remove('hidden');
        
        if (err.name === 'AbortError') {
          summaryText.innerHTML = '<div class="text-amber-600">Request cancelled by user</div>';
        } else {
          summaryText.innerHTML = `<div class="text-red-600">Error: ${escapeHtml(err.message || 'Unknown error')}</div>`;
        }
        usageInfo.classList.add('hidden');
        pdfMetadata.classList.add('hidden');
        setContent(usageInfo, '');
        setContent(pdfMetadata, '');
        
        // Hide copy and maximize buttons on error
        copyButton.classList.add('hidden');
        fullscreenButton.classList.add('hidden');
      } finally {
        runBtn.classList.remove('hidden');
        cancelBtn.classList.add('hidden');
        abortController = null;
      }
    }

    function displayPdfMetadata(metadata) {
      if (!metadata) return;
      
      pdfMetadata.classList.remove('hidden');
      
      let metadataHtml = '<div class="flex items-center gap-2 mb-2">';
      metadataHtml += '<svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
      metadataHtml += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>';
      metadataHtml += '</svg>';
      metadataHtml += '<span class="font-medium text-blue-800">PDF Information</span>';
      metadataHtml += '</div>';
      
      metadataHtml += '<div class="space-y-1 text-sm">';
      if (metadata.title) {
        metadataHtml += '<div><span class="font-medium">Title:</span> ' + metadata.title + '</div>';
      }
      if (metadata.author) {
        metadataHtml += '<div><span class="font-medium">Author:</span> ' + metadata.author + '</div>';
      }
      if (metadata.pages) {
        metadataHtml += '<div><span class="font-medium">Pages:</span> ' + metadata.pages + '</div>';
      }
      if (metadata.extractedTextLength) {
        metadataHtml += '<div><span class="font-medium">Text Length:</span> ' + metadata.extractedTextLength.toLocaleString() + ' characters</div>';
      }
      metadataHtml += '</div>';
      
      pdfMetadata.innerHTML = metadataHtml;
    }

    function displayUsageMetrics(usage, responseTime) {
      usageInfo.classList.remove('hidden');
      
      let metricsHtml = '<div class="metrics-container">';
      metricsHtml += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3">';
      
      // Response Time metric
      metricsHtml += '<div class="metric-item">' +
        '<div class="metric-icon">' +
          '<svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
          '</svg>' +
        '</div>' +
        '<div>' +
          '<div class="metric-label">Response</div>' +
          '<div class="metric-value text-orange-600">' + responseTime + ' ms</div>' +
        '</div>' +
      '</div>';
      
      if (usage) {
        const inputTokens = usage.input_tokens || usage.prompt_tokens || 0;
        const outputTokens = usage.output_tokens || usage.completion_tokens || 0;
        const totalTokens = usage.total_tokens || (inputTokens + outputTokens);
        
        // Input Tokens
        metricsHtml += '<div class="metric-item">' +
          '<div class="metric-icon">' +
            '<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>' +
            '</svg>' +
          '</div>' +
          '<div>' +
            '<div class="metric-label">Input</div>' +
            '<div class="metric-value text-blue-600">' + inputTokens.toLocaleString() + '</div>' +
          '</div>' +
        '</div>';
        
        // Output Tokens
        metricsHtml += '<div class="metric-item">' +
          '<div class="metric-icon">' +
            '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>' +
            '</svg>' +
          '</div>' +
          '<div>' +
            '<div class="metric-label">Output</div>' +
            '<div class="metric-value text-green-600">' + outputTokens.toLocaleString() + '</div>' +
          '</div>' +
        '</div>';
        
        // Total Tokens
        metricsHtml += '<div class="metric-item">' +
          '<div class="metric-icon">' +
            '<svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>' +
            '</svg>' +
          '</div>' +
          '<div>' +
            '<div class="metric-label">Total</div>' +
            '<div class="metric-value text-purple-600">' + totalTokens.toLocaleString() + '</div>' +
          '</div>' +
        '</div>';
      }
      
      metricsHtml += '</div></div>';
      const metricsDiv = createElement('div');
      metricsDiv.innerHTML = metricsHtml;
      setContent(usageInfo, metricsDiv.firstChild);
    }

    // Copy and Fullscreen functionality
    let isFullscreen = false;
    let originalOutputHTML = null;
    let backdropEl = null;

    function ensureBackdrop() {
      if (!backdropEl) {
        backdropEl = document.createElement('div');
        backdropEl.className = 'fullscreen-backdrop';
        backdropEl.addEventListener('click', exitFullscreen);
        document.body.appendChild(backdropEl);
      }
    }

    function enterFullscreen() {
      if (isFullscreen) return;
      ensureBackdrop();
      originalOutputHTML = outputPanel.innerHTML;
      outputPanel.classList.add('fullscreen-output');
      backdropEl.classList.add('active');

      const content = `
        <button onclick="exitFullscreen()" class="close-button" title="Close (ESC)">✕</button>
        <div class="fullscreen-inner">
          <div class="fullscreen-body">${originalOutputHTML}</div>
        </div>`;
      outputPanel.innerHTML = content;
      isFullscreen = true;
      document.addEventListener('keydown', handleEsc);
      
      // Bind close button explicitly to ensure it works across browsers
      const closeBtn = outputPanel.querySelector('.close-button');
      if (closeBtn) closeBtn.addEventListener('click', exitFullscreen);
    }

    function exitFullscreen() {
      if (!isFullscreen) return;
      outputPanel.classList.remove('fullscreen-output');
      if (backdropEl) backdropEl.classList.remove('active');
      outputPanel.innerHTML = originalOutputHTML;
      isFullscreen = false;
      document.removeEventListener('keydown', handleEsc);
      
      // Rebind button after restore
      const btn = document.getElementById('fullscreenButton');
      if (btn) btn.onclick = toggleOutputFullscreen;
    }

    function handleEsc(e) {
      if (e.key === 'Escape') exitFullscreen();
    }

    function toggleOutputFullscreen() {
      isFullscreen ? exitFullscreen() : enterFullscreen();
    }

    function copyOutput() {
      const el = document.querySelector('#outputPanel #summaryText') || document.getElementById('summaryText');
      if (!el) return;
      const text = el.innerText || '';
      const btn = document.querySelector('#outputPanel #copyButton') || document.getElementById('copyButton');
      
      const setCopiedUI = () => {
        if (!btn) return;
        const original = btn.getAttribute('data-original') || btn.textContent;
        btn.setAttribute('data-original', original);
        btn.textContent = 'Copied!';
        btn.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
        setTimeout(() => {
          btn.textContent = btn.getAttribute('data-original') || 'Copy';
          btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-200');
        }, 1200);
      };

      const doCopy = () => {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(setCopiedUI).catch(() => {
            // Fallback to older method
            try {
              const textarea = document.createElement('textarea');
              textarea.value = text;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              setCopiedUI();
            } catch (e) {
              console.error('Copy failed:', e);
            }
          });
        } else {
          // Fallback to older method
          try {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            setCopiedUI();
          } catch (e) {
            console.error('Copy failed:', e);
          }
        }
      };

      doCopy();
    }

    // Expose for inline handlers
    window.exitFullscreen = exitFullscreen;
    window.toggleOutputFullscreen = toggleOutputFullscreen;
    window.copyOutput = copyOutput;

    pdfUrlEl.addEventListener('input', updatePreview);
    maxLengthEl.addEventListener('input', updatePreview);
    temperatureEl.addEventListener('input', updatePreview);
    streamingEl.addEventListener('change', updatePreview);
    providerEl.addEventListener('change', () => {
      updateModelOptions();
    });
    tokenEl.addEventListener('change', () => {
      // Re-fetch models using the provided token (needed in production)
      initModels();
    });
    modelEl.addEventListener('change', updatePreview);

    runBtn.addEventListener('click', run);
    cancelBtn.addEventListener('click', () => {
      if (abortController) abortController.abort();
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
    });
    loadSampleBtn.addEventListener('click', () => setFromSample());

    // Initialize models from backend, then load sample
    initModels().then(() => setFromSample());
  </script>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-20">
    <div class="container mx-auto px-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
          <h3 class="text-xl font-semibold mb-4">Documentation</h3>
          <ul class="space-y-2">
            <li><a href="/api/ui" target="_blank" class="text-gray-300 hover:text-white transition-colors">Swagger UI</a></li>
            <li><a href="/api/doc" target="_blank" class="text-gray-300 hover:text-white transition-colors">API Reference</a></li>
            <li><a href="/api/demos" class="text-gray-300 hover:text-white transition-colors">Live Demos</a></li>
            <li><a href="/api/models" class="text-gray-300 hover:text-white transition-colors">Models Guide</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-semibold mb-4">Resources</h3>
          <ul class="space-y-2">
            <li><a href="https://github.com/donvito/ai-backend" class="text-gray-300 hover:text-white transition-colors">GitHub Repository</a></li>
            <li><a href="https://github.com/donvito/ai-backend/issues" class="text-gray-300 hover:text-white transition-colors">Issues & Support</a></li>
            <li><a href="https://github.com/donvito/ai-backend/blob/main/README.md" class="text-gray-300 hover:text-white transition-colors">Setup Guide</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-semibold mb-4">About</h3>
          <p class="text-gray-300 text-sm leading-relaxed">
            Open source AI backend making common AI use cases easily accessible and customizable. 
            100% self-hosted with complete control over your data.
          </p>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
        <p>&copy; 2025 AI Backends. Open source under MIT License.</p>
      </div>
    </div>
  </footer>
</body>
</html>