<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Backends - Synthetic Data Generation Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-purple': '#B341F9',
            'brand-pink': '#E453C0',
            'terminal-bg': '#1C2128',
            'terminal-text': '#A7B5C4'
          },
          backgroundImage: {
            'gradient-brand': 'linear-gradient(135deg, #B341F9, #E453C0)',
          }
        }
      }
    }
  </script>
  <style>
    .metrics-container {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #e5e7eb;
    }
    .metric-item {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .metric-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .metric-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }
    .metric-value {
      font-size: 14px;
      font-weight: 600;
    }
    .json-output {
      background: #1a1a1a;
      color: #e5e5e5;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      border-radius: 8px;
      padding: 16px;
      overflow: auto;
      max-height: 400px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .json-string { color: #98c379; }
    .json-number { color: #d19a66; }
    .json-boolean { color: #56b6c2; }
    .json-null { color: #c678dd; }
    .json-key { color: #61afef; }
    .copy-button {
      position: relative;
      transition: all 0.2s;
    }
    .copy-button:hover {
      transform: translateY(-1px);
    }
    .copy-button.copied {
      background: #10b981 !important;
    }
    .copy-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .copy-button.streaming {
      opacity: 0.6;
      cursor: wait;
      background: #6b7280 !important;
    }
    .schema-editor-wrapper {
      position: relative;
      border-radius: 8px;
    }
    .schema-editor {
      position: relative;
      width: 100%;
      min-height: 128px;
      max-height: 300px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      background: #fafafa;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: pre-wrap;
      word-wrap: break-word;
      outline: none;
    }
    .schema-editor::-webkit-scrollbar {
      width: 8px;
    }
    .schema-editor::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    .schema-editor::-webkit-scrollbar-thumb {
      background: #B341F9;
      border-radius: 4px;
    }
    .schema-editor::-webkit-scrollbar-thumb:hover {
      background: #9935D9;
    }
    /* Custom scrollbar for sections */
    section::-webkit-scrollbar {
      width: 10px;
    }
    section::-webkit-scrollbar-track {
      background: #f9fafb;
    }
    section::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 5px;
    }
    section::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
    .schema-editor:focus {
      border-color: #B341F9;
      box-shadow: 0 0 0 2px rgba(179, 65, 249, 0.2);
      background: #ffffff;
    }
    .schema-editor:empty:before {
      content: attr(data-placeholder);
      color: #9ca3af;
    }
    .schema-editor.error-border {
      border-color: #ef4444;
    }
    .schema-editor.success-border {
      border-color: #10b981;
    }
    .schema-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 12px;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: auto;
      pointer-events: none;
      color: transparent;
      background: transparent;
    }
  </style>
  <script src="/api/shared/safedom.js"></script>
</head>
<body class="bg-white min-h-screen">
  <!-- Navigation -->
  <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-lg border-b border-gray-100">
    <div class="container mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <a href="/" class="flex items-center space-x-2">
          <div class="w-10 h-10 rounded-xl bg-[#B341F9] flex items-center justify-center">
            <span class="text-white font-bold text-xl">AI</span>
          </div>
          <span class="text-2xl font-bold text-gray-900">Backends</span>
          <span class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-50 text-green-700">
            <svg class="w-4 h-4 mr-1" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z"/>
            </svg>
            Open Source
          </span>
        </a>
        <div class="flex items-center space-x-6">
          <a href="/api/ui" target="_blank" class="text-gray-700 hover:text-brand-purple transition-colors duration-300">API Docs</a>
          <a href="/api/demos" class="text-gray-700 hover:text-brand-purple transition-colors duration-300">Demos</a>
          <a href="/api/jsoneditor" target="_blank" class="text-gray-700 hover:text-brand-purple transition-colors duration-300">JSON Editor</a>
          <a href="/api/models" class="text-gray-700 hover:text-brand-purple transition-colors duration-300">Models Guide</a>
          <a href="https://github.com/donvito/ai-backend" class="inline-flex items-center px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors duration-300">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 0C4.477 0 0 4.484 0 10.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z" clip-rule="evenodd"/>
            </svg>
            GitHub
          </a>
        </div>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-6 py-12">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
      <ol class="flex items-center space-x-2 text-gray-500">
        <li><a href="/" class="hover:text-gray-700">Home</a></li>
        <li><span>/</span></li>
        <li><a href="/api/demos" class="hover:text-gray-700">Demos</a></li>
        <li><span>/</span></li>
        <li class="text-gray-900 font-medium">Synthetic Data Generation</li>
      </ol>
    </nav>

    <!-- Demo Title and Description -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-3">Synthetic Data Generation Demo</h1>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Generate synthetic data based on prompts with optional JSON schema validation
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
      <!-- Controls -->
      <section class="bg-white p-6 rounded-2xl border border-gray-100 shadow-lg hover:shadow-xl transition-shadow duration-300">
        <h2 class="text-lg font-semibold mb-4">Input</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Data Description Prompt</label>
            <textarea id="promptText" class="w-full h-32 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple bg-white" placeholder="Describe the synthetic data you want to generate..."></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Count</label>
            <input id="count" type="number" min="1" max="100" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple" value="5" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Provider</label>
              <select id="provider" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple">
                <option value="ollama">ollama</option>
                <option value="openai">openai</option>
                <option value="openrouter">openrouter</option>
                <option value="lmstudio">lmstudio</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
              <select id="model" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple"></select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Temperature</label>
            <input id="temperature" type="number" step="0.1" min="0" max="1" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple" value="0.7" />
          </div>

          <div>
            <div class="flex justify-between items-center mb-1">
              <label class="block text-sm font-medium text-gray-700">JSON Schema (Required)</label>
              <div class="flex items-center gap-2">
                <button id="validateSchemaBtn" class="text-xs px-2 py-1 rounded bg-blue-50 text-blue-700 hover:bg-blue-100 transition-colors">
                  Validate
                </button>
                <button id="clearSchemaBtn" class="text-xs px-2 py-1 rounded bg-gray-50 text-gray-700 hover:bg-gray-100 transition-colors">
                  Clear
                </button>
                <button id="formatSchemaBtn" class="text-xs px-2 py-1 rounded bg-purple-50 text-purple-700 hover:bg-purple-100 transition-colors">
                  Format
                </button>
              </div>
            </div>
            <div class="relative schema-editor-wrapper">
              <div 
                id="jsonSchema" 
                class="schema-editor" 
                contenteditable="true" 
                spellcheck="false"
                data-placeholder='{"type": "object", "properties": {...}}'
              ></div>
              <div id="schemaValidation" class="hidden absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium z-10"></div>
            </div>
            <div id="schemaError" class="hidden mt-1 text-xs text-red-600"></div>
            <p class="text-xs text-gray-500 mt-1">Provide a JSON schema to validate the generated data structure</p>
          </div>

          <div class="flex items-center gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input id="streaming" type="checkbox" class="w-4 h-4 text-brand-purple rounded focus:ring-2 focus:ring-brand-purple" checked />
              <span class="text-sm font-medium text-gray-700">Enable Streaming</span>
            </label>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Bearer Token (optional)</label>
            <input id="token" type="password" placeholder="Only needed in production deployments" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple" />
          </div>

          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Load Sample Example</label>
              <select id="exampleSelector" class="w-full p-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-brand-purple">
                <option value="socialMedia">Social Media Profiles</option>
                <option value="creditCardInquiries">Credit Card Customer Conversations</option>
              </select>
            </div>
            
            <div class="flex items-center gap-2">
              <button id="runBtn" class="px-4 py-2 rounded-lg bg-brand-purple text-white hover:bg-[#9935D9]">Generate Data</button>
              <button id="cancelBtn" class="hidden px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Cancel</button>
              <button id="loadSample" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200">Load Selected Example</button>
            </div>
          </div>

          <details class="mt-4">
            <summary class="text-sm text-gray-600 cursor-pointer">View JSON request</summary>
            <pre id="jsonPreview" class="mt-2 bg-gray-900 text-green-400 p-3 rounded-lg text-xs mono overflow-auto"></pre>
          </details>
        </div>
      </section>

      <!-- Output -->
      <section class="bg-white p-6 rounded-2xl border border-gray-100 shadow-lg hover:shadow-xl transition-shadow duration-300">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Output</h2>
          <button id="copyBtn" class="copy-button hidden px-3 py-1.5 rounded-lg bg-gray-700 text-white text-sm hover:bg-gray-600 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <span id="copyBtnText">Copy</span>
          </button>
        </div>
        <div id="usageInfo" class="hidden mb-3 text-sm"></div>
        <div id="outputData" class="json-output min-h-[200px]">Generated data will appear here...</div>
        <div id="validationStatus" class="hidden mt-3 p-3 rounded-lg text-sm font-medium"></div>
      </section>
    </div>
  </main>

  <script>
    // Sample examples for different use cases
    const sampleExamples = {
      socialMedia: {
        name: "Social Media Profiles",
        payload: {
          prompt: "Generate user profiles for a social media platform with realistic demographic information, interests, and activity metrics",
          count: 3,
          schema: {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "id": {"type": "string"},
                "username": {"type": "string"},
                "email": {"type": "string"},
                "age": {"type": "number", "minimum": 18, "maximum": 80},
                "location": {"type": "string"},
                "interests": {"type": "array", "items": {"type": "string"}},
                "followers": {"type": "number", "minimum": 0},
                "following": {"type": "number", "minimum": 0},
                "posts": {"type": "number", "minimum": 0},
                "verified": {"type": "boolean"},
                "joinDate": {"type": "string"}
              },
              "required": ["id", "username", "email", "age"]
            }
          }
        },
        config: {
          provider: "ollama",
          model: "gemma3:4b",
          temperature: 0.7,
          stream: true
        }
      },
      creditCardInquiries: {
        name: "Credit Card Customer Conversations",
        payload: {
          prompt: "Generate realistic customer service conversations about credit card inquiries. Include various topics like balance inquiries, payment issues, fraud alerts, credit limit increases, rewards questions, and statement disputes. Make conversations natural with 3-5 message exchanges between customer and agent.",
          count: 3,
          schema: {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "conversation_id": {
                  "type": "string"
                },
                "messages": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "speaker": {
                        "type": "string",
                        "enum": ["customer", "agent"]
                      },
                      "text": {
                        "type": "string"
                      },
                      "timestamp": {
                        "type": "string",
                        "format": "date-time"
                      }
                    },
                    "required": [
                      "speaker",
                      "text"
                    ]
                  }
                }
              },
              "required": [
                "conversation_id",
                "messages"
              ]
            }
          }
        },
        config: {
          provider: "ollama",
          model: "gemma3:4b",
          temperature: 0.8,
          stream: true
        }
      }
    };
    
    // Default to social media example
    let currentExample = 'socialMedia';
    const samplePayload = sampleExamples[currentExample];

    const promptText = document.getElementById('promptText');
    const countEl = document.getElementById('count');
    const jsonSchemaEl = document.getElementById('jsonSchema');
    const temperatureEl = document.getElementById('temperature');
    const providerEl = document.getElementById('provider');
    const modelEl = document.getElementById('model');
    const tokenEl = document.getElementById('token');
    const streamingEl = document.getElementById('streaming');
    const runBtn = document.getElementById('runBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const loadSampleBtn = document.getElementById('loadSample');
    const exampleSelector = document.getElementById('exampleSelector');
    const outputData = document.getElementById('outputData');
    const usageInfo = document.getElementById('usageInfo');
    const validationStatus = document.getElementById('validationStatus');
    const jsonPreview = document.getElementById('jsonPreview');
    const copyBtn = document.getElementById('copyBtn');
    const copyBtnText = document.getElementById('copyBtnText');
    const validateSchemaBtn = document.getElementById('validateSchemaBtn');
    const clearSchemaBtn = document.getElementById('clearSchemaBtn');
    const formatSchemaBtn = document.getElementById('formatSchemaBtn');
    const schemaValidation = document.getElementById('schemaValidation');
    const schemaError = document.getElementById('schemaError');

    let abortController = null;
    let currentJsonData = null; // Store the raw JSON data for copying
    let schemaValidationTimeout = null;
    let isStreaming = false; // Track streaming state

    // Dynamic model options fetched from backend
    let modelOptions = null;

    // Fallback options if fetch fails or endpoint is unavailable
    const fallbackModelOptions = {
      ollama: [
        { value: 'gemma3:4b', label: 'gemma3:4b (default)' }
      ],
      openai: [
        { value: 'gpt-4o-mini', label: 'gpt-4o-mini' },
        { value: 'gpt-4.1-nano', label: 'gpt-4.1-nano' },
        { value: 'gpt-5-nano', label: 'gpt-5-nano' }
      ],
      openrouter: [
        { value: 'openai/gpt-4o-mini', label: 'openai/gpt-4o-mini' }
      ],
      lmstudio: [
        { value: 'gemma-3-270m-it', label: 'gemma-3-270m-it' },
        { value: 'llama-3.2-3b-instruct', label: 'llama-3.2-3b-instruct' }
      ]
    };

    function updateModelOptions() {
      const provider = providerEl.value;
      const source = modelOptions || fallbackModelOptions;
      const models = (source && source[provider]) ? source[provider] : [];
      setContent(modelEl, createOptions(models));
      updatePreview();
    }

    async function fetchModels() {
      const headers = {};
      const token = tokenEl.value.trim();
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch('/api/v1/services/models?source=config&view=capability', { headers });
      if (!res.ok) throw new Error('Failed to load models: ' + res.status);
      const data = await res.json();
      // For synthetic data, we can use any text generation models
      const textGeneration = data && data.byCapability && (data.byCapability.compose || data.byCapability.askText);
      if (!textGeneration || typeof textGeneration !== 'object') throw new Error('Invalid models response');
      const mapped = {};
      for (const provider in textGeneration) {
        const list = Array.isArray(textGeneration[provider]) ? textGeneration[provider] : [];
        mapped[provider] = list.map(name => ({ value: name, label: name }));
      }
      return mapped;
    }

    async function initModels() {
      try {
        modelOptions = await fetchModels();
      } catch (e) {
        modelOptions = null; // fall back to static options
      }
      const source = modelOptions || fallbackModelOptions;
      const providers = Object.keys(source);
      setContent(providerEl, createOptions(providers.map(p => ({ value: p, label: p }))));
      if (!providers.includes(providerEl.value)) {
        providerEl.value = providers[0] || '';
      }
      updateModelOptions();
    }

    /**
     * Get plain text from contenteditable div
     */
    function getSchemaText() {
      return jsonSchemaEl.textContent || jsonSchemaEl.innerText || '';
    }

    /**
     * Set text in contenteditable div with syntax highlighting
     */
    function setSchemaText(text) {
      if (!text) {
        jsonSchemaEl.innerHTML = '';
        return;
      }
      
      try {
        // Try to parse and highlight
        const parsed = JSON.parse(text);
        const formatted = JSON.stringify(parsed, null, 2);
        jsonSchemaEl.innerHTML = syntaxHighlight(formatted);
      } catch (e) {
        // If invalid JSON, just set as plain text
        jsonSchemaEl.textContent = text;
      }
    }

    /**
     * Apply syntax highlighting to contenteditable on input
     */
    function highlightSchema() {
      const text = getSchemaText().trim();
      
      if (!text) {
        return;
      }
      
      try {
        // Save cursor position
        const selection = window.getSelection();
        const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
        const cursorOffset = range ? range.startOffset : 0;
        const cursorNode = range ? range.startContainer : null;
        
        // Parse and highlight
        const parsed = JSON.parse(text);
        const formatted = JSON.stringify(parsed, null, 2);
        const highlighted = syntaxHighlight(formatted);
        
        // Only update if content changed to avoid cursor jump
        if (jsonSchemaEl.innerHTML !== highlighted) {
          jsonSchemaEl.innerHTML = highlighted;
          
          // Restore cursor position (best effort)
          try {
            if (cursorNode && jsonSchemaEl.contains(cursorNode)) {
              const newRange = document.createRange();
              newRange.setStart(cursorNode, Math.min(cursorOffset, cursorNode.length || 0));
              newRange.collapse(true);
              selection.removeAllRanges();
              selection.addRange(newRange);
            }
          } catch (e) {
            // Cursor restoration failed, not critical
          }
        }
      } catch (e) {
        // Invalid JSON, don't highlight
      }
    }

    function buildRequest() {
      let schema = null;
      const schemaText = getSchemaText().trim();
      if (schemaText) {
        try {
          schema = JSON.parse(schemaText);
        } catch (e) {
          // Invalid JSON schema, will be handled in validation
        }
      }

      return {
        payload: {
          prompt: promptText.value.trim(),
          count: Math.max(1, Math.min(100, Number(countEl.value) || 1)),
          schema: schema
        },
        config: {
          provider: providerEl.value,
          model: modelEl.value,
          temperature: Number(temperatureEl.value) || 0,
          stream: streamingEl.checked
        }
      };
    }

    function updatePreview() {
      const req = buildRequest();
      jsonPreview.textContent = JSON.stringify(req, null, 2);
    }

    /**
     * Syntax highlight JSON
     */
    function syntaxHighlight(json) {
      if (typeof json !== 'string') {
        json = JSON.stringify(json, null, 2);
      }
      
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'json-number';
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = 'json-key';
          } else {
            cls = 'json-string';
          }
        } else if (/true|false/.test(match)) {
          cls = 'json-boolean';
        } else if (/null/.test(match)) {
          cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    /**
     * Display formatted JSON with syntax highlighting
     */
    function displayFormattedJSON(data, enableCopy = true) {
      try {
        const jsonString = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        currentJsonData = jsonString; // Store for copying
        const highlighted = syntaxHighlight(jsonString);
        outputData.innerHTML = highlighted;
        
        // Only show copy button if not streaming or if streaming is complete
        if (enableCopy && !isStreaming) {
          copyBtn.classList.remove('hidden');
          copyBtn.disabled = false;
          copyBtn.style.opacity = '1';
        }
      } catch (e) {
        outputData.textContent = typeof data === 'string' ? data : JSON.stringify(data);
        currentJsonData = outputData.textContent;
        
        if (enableCopy && !isStreaming) {
          copyBtn.classList.remove('hidden');
          copyBtn.disabled = false;
          copyBtn.style.opacity = '1';
        }
      }
    }

    /**
     * Copy JSON to clipboard
     */
    async function copyToClipboard() {
      if (!currentJsonData) return;
      
      try {
        await navigator.clipboard.writeText(currentJsonData);
        
        // Visual feedback
        const originalBg = copyBtn.className;
        copyBtn.classList.add('copied');
        copyBtnText.textContent = 'Copied!';
        
        setTimeout(() => {
          copyBtn.className = originalBg;
          copyBtnText.textContent = 'Copy';
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
        copyBtnText.textContent = 'Failed';
        setTimeout(() => {
          copyBtnText.textContent = 'Copy';
        }, 2000);
      }
    }

    /**
     * Validate JSON schema
     */
    function validateJsonSchema() {
      const schemaText = getSchemaText().trim();
      
      // Clear previous validation
      schemaValidation.classList.add('hidden');
      schemaError.classList.add('hidden');
      jsonSchemaEl.classList.remove('error-border', 'success-border');
      
      if (!schemaText) {
        return { valid: true, schema: null };
      }
      
      try {
        const schema = JSON.parse(schemaText);
        
        // Basic schema validation
        if (typeof schema !== 'object' || schema === null) {
          throw new Error('Schema must be an object');
        }
        
        // Show success
        schemaValidation.classList.remove('hidden');
        schemaValidation.className = 'hidden absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800 z-10';
        schemaValidation.classList.remove('hidden');
        schemaValidation.textContent = '✓ Valid';
        jsonSchemaEl.classList.add('success-border');
        
        setTimeout(() => {
          schemaValidation.classList.add('hidden');
          jsonSchemaEl.classList.remove('success-border');
        }, 3000);
        
        return { valid: true, schema };
      } catch (e) {
        // Show error
        schemaValidation.classList.remove('hidden');
        schemaValidation.className = 'hidden absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800 z-10';
        schemaValidation.classList.remove('hidden');
        schemaValidation.textContent = '✗ Invalid';
        jsonSchemaEl.classList.add('error-border');
        
        schemaError.classList.remove('hidden');
        schemaError.textContent = '❌ ' + e.message;
        
        return { valid: false, error: e.message };
      }
    }

    /**
     * Format JSON schema
     */
    function formatJsonSchema() {
      const schemaText = getSchemaText().trim();
      
      if (!schemaText) return;
      
      try {
        const schema = JSON.parse(schemaText);
        const formatted = JSON.stringify(schema, null, 2);
        setSchemaText(formatted);
        
        // Show success feedback
        schemaValidation.classList.remove('hidden');
        schemaValidation.className = 'hidden absolute top-2 right-2 px-2 py-1 rounded text-xs font-medium bg-purple-100 text-purple-800 z-10';
        schemaValidation.classList.remove('hidden');
        schemaValidation.textContent = '✓ Formatted';
        
        setTimeout(() => {
          schemaValidation.classList.add('hidden');
        }, 2000);
        
        updatePreview();
      } catch (e) {
        schemaError.classList.remove('hidden');
        schemaError.textContent = '❌ Cannot format invalid JSON: ' + e.message;
        jsonSchemaEl.classList.add('error-border');
      }
    }

    /**
     * Clear JSON schema
     */
    function clearJsonSchema() {
      jsonSchemaEl.innerHTML = '';
      schemaValidation.classList.add('hidden');
      schemaError.classList.add('hidden');
      jsonSchemaEl.classList.remove('error-border', 'success-border');
      updatePreview();
    }

    /**
     * Auto-validate schema on input (debounced)
     */
    function autoValidateSchema() {
      clearTimeout(schemaValidationTimeout);
      schemaValidationTimeout = setTimeout(() => {
        const schemaText = getSchemaText().trim();
        if (schemaText) {
          validateJsonSchema();
        } else {
          schemaValidation.classList.add('hidden');
          schemaError.classList.add('hidden');
          jsonSchemaEl.classList.remove('error-border', 'success-border');
        }
      }, 1000);
    }

    function setFromSample() {
      const selectedExample = exampleSelector.value;
      const example = sampleExamples[selectedExample];
      
      if (!example) return;
      
      promptText.value = example.payload.prompt;
      countEl.value = example.payload.count || 1;
      
      // Set schema with syntax highlighting
      if (example.payload.schema) {
        const schemaStr = JSON.stringify(example.payload.schema, null, 2);
        setSchemaText(schemaStr);
      } else {
        jsonSchemaEl.innerHTML = '';
      }
      
      streamingEl.checked = example.config.stream !== false;
      providerEl.value = example.config.provider || 'ollama';
      updateModelOptions();
      modelEl.value = example.config.model || 'gemma3:4b';
      temperatureEl.value = example.config.temperature || 0.7;
      updatePreview();
    }

    function displayValidationStatus(metadata) {
      if (metadata && typeof metadata.validation_passed === 'boolean') {
        validationStatus.classList.remove('hidden');
        if (metadata.validation_passed) {
          validationStatus.className = 'mt-3 p-3 rounded-lg text-sm font-medium bg-green-50 text-green-800 border border-green-200';
          validationStatus.textContent = '✓ Generated data passed schema validation';
        } else {
          validationStatus.className = 'mt-3 p-3 rounded-lg text-sm font-medium bg-yellow-50 text-yellow-800 border border-yellow-200';
          validationStatus.textContent = '⚠ Generated data did not fully match the provided schema';
        }
      } else {
        validationStatus.classList.add('hidden');
      }
    }

    async function run() {
      const req = buildRequest();
      updatePreview();
      const headers = { 'Content-Type': 'application/json' };
      const token = tokenEl.value.trim();
      if (token) headers['Authorization'] = 'Bearer ' + token;

      abortController = new AbortController();

      runBtn.classList.add('hidden');
      cancelBtn.classList.remove('hidden');

      outputData.textContent = 'Generating synthetic data...';
      copyBtn.classList.add('hidden');
      usageInfo.classList.add('hidden');
      validationStatus.classList.add('hidden');
      setContent(usageInfo, '');

      const startTime = performance.now();

      try {
        if (req.config.stream) {
          isStreaming = true; // Set streaming flag
          
          // Show copy button as disabled during streaming
          copyBtn.classList.remove('hidden');
          copyBtn.disabled = true;
          copyBtn.classList.add('streaming');
          copyBtnText.textContent = 'Streaming...';
          
          // Streaming mode using Server-Sent Events
          const response = await fetch('/api/v1/synthetic-data', {
            method: 'POST',
            headers,
            body: JSON.stringify(req),
            signal: abortController.signal
          });

          if (!response.ok) {
            const txt = await response.text();
            throw new Error('Request failed: ' + response.status + ' ' + txt);
          }

          // Check if we got SSE content type
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('text/event-stream')) {
            // Fallback to non-streaming if server didn't return SSE
            isStreaming = false;
            copyBtn.classList.remove('streaming');
            copyBtnText.textContent = 'Copy';
            
            const data = await response.json();
            const generatedData = data?.data || data?.data?.data || {};
            displayFormattedJSON(generatedData, true);
            const endTime = performance.now();
            const responseTime = (endTime - startTime).toFixed(2);
            const usage = data?.usage || data?.data?.usage;
            const metadata = data?.metadata || data?.data?.metadata;
            if (usage) {
              displayUsageMetrics(usage, responseTime);
            }
            displayValidationStatus(metadata);
            return;
          }

          // Clear the initial message
          outputData.textContent = '';
          let accumulatedText = '';
          let usage = null;
          let metadata = null;

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';

            for (const line of lines) {
              if (line.trim().startsWith('data:')) {
                const data = line.replace(/^data:\s*/, '');
                if (data.trim() === '[DONE]' || data.trim() === '') {
                  continue;
                }
                try {
                  const parsed = JSON.parse(data);
                  if (parsed.chunk) {
                    accumulatedText += parsed.chunk;
                    outputData.textContent = accumulatedText;
                  }
                  if (parsed.done && parsed.usage) {
                    usage = parsed.usage;
                  }
                  if (parsed.done && parsed.metadata) {
                    metadata = parsed.metadata;
                  }
                  if (parsed.error) {
                    throw new Error(parsed.error);
                  }
                } catch (e) {
                  if (e instanceof SyntaxError) {
                    console.warn('Failed to parse SSE data:', data);
                  } else {
                    throw e;
                  }
                }
              }
            }
          }

          const endTime = performance.now();
          const responseTime = (endTime - startTime).toFixed(2);

          // Streaming complete - enable copy
          isStreaming = false;
          copyBtn.disabled = false;
          copyBtn.classList.remove('streaming');
          copyBtnText.textContent = 'Copy';

          // Format and display the accumulated JSON
          try {
            const jsonData = JSON.parse(accumulatedText);
            displayFormattedJSON(jsonData, true);
          } catch (e) {
            outputData.textContent = accumulatedText;
            currentJsonData = accumulatedText;
            copyBtn.classList.remove('hidden', 'streaming');
            copyBtn.disabled = false;
            copyBtnText.textContent = 'Copy';
          }

          // Display usage metrics if available
          if (usage) {
            displayUsageMetrics(usage, responseTime);
          }
          displayValidationStatus(metadata);
        } else {
          // Non-streaming mode - not streaming
          isStreaming = false;
          // Non-streaming mode
          const res = await fetch('/api/v1/synthetic-data', {
            method: 'POST',
            headers,
            body: JSON.stringify(req),
            signal: abortController.signal
          });
          const endTime = performance.now();
          const responseTime = (endTime - startTime).toFixed(2);
          
          if (!res.ok) {
            const txt = await res.text();
            throw new Error('Request failed: ' + res.status + ' ' + txt);
          }
          const data = await res.json();
          const generatedData = data?.data || data?.data?.data || {};
          displayFormattedJSON(generatedData);

          const usage = data?.usage || data?.data?.usage;
          const metadata = data?.metadata || data?.data?.metadata;
          if (usage) {
            displayUsageMetrics(usage, responseTime);
          }
          displayValidationStatus(metadata);
        }
      } catch (err) {
        isStreaming = false; // Reset streaming flag on error
        copyBtn.classList.remove('streaming');
        copyBtn.disabled = false;
        copyBtnText.textContent = 'Copy';
        
        if (err.name === 'AbortError') {
          outputData.textContent = 'Request cancelled by user';
        } else {
          outputData.textContent = 'Error: ' + (err.message || 'Unknown error');
        }
        copyBtn.classList.add('hidden');
        usageInfo.classList.add('hidden');
        validationStatus.classList.add('hidden');
        setContent(usageInfo, '');
      } finally {
        isStreaming = false; // Always reset streaming flag
        copyBtn.classList.remove('streaming');
        copyBtn.disabled = false;
        copyBtnText.textContent = 'Copy';
        runBtn.classList.remove('hidden');
        cancelBtn.classList.add('hidden');
        abortController = null;
      }
    }

    function displayUsageMetrics(usage, responseTime) {
      usageInfo.classList.remove('hidden');
      
      let metricsHtml = '<div class="metrics-container">';
      metricsHtml += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-3">';
      
      // Response Time metric
      metricsHtml += '<div class="metric-item">' +
        '<div class="metric-icon">' +
          '<svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
          '</svg>' +
        '</div>' +
        '<div>' +
          '<div class="metric-label">Response</div>' +
          '<div class="metric-value text-orange-600">' + responseTime + ' ms</div>' +
        '</div>' +
      '</div>';
      
      if (usage) {
        const inputTokens = usage.input_tokens || usage.prompt_tokens || 0;
        const outputTokens = usage.output_tokens || usage.completion_tokens || 0;
        const totalTokens = usage.total_tokens || (inputTokens + outputTokens);
        
        // Input Tokens
        metricsHtml += '<div class="metric-item">' +
          '<div class="metric-icon">' +
            '<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>' +
            '</svg>' +
          '</div>' +
          '<div>' +
            '<div class="metric-label">Input</div>' +
            '<div class="metric-value text-blue-600">' + inputTokens.toLocaleString() + '</div>' +
          '</div>' +
        '</div>';
        
        // Output Tokens
        metricsHtml += '<div class="metric-item">' +
          '<div class="metric-icon">' +
            '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>' +
            '</svg>' +
          '</div>' +
          '<div>' +
            '<div class="metric-label">Output</div>' +
            '<div class="metric-value text-green-600">' + outputTokens.toLocaleString() + '</div>' +
          '</div>' +
        '</div>';
        
        // Total Tokens
        metricsHtml += '<div class="metric-item">' +
          '<div class="metric-icon">' +
            '<svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>' +
            '</svg>' +
          '</div>' +
          '<div>' +
            '<div class="metric-label">Total</div>' +
            '<div class="metric-value text-purple-600">' + totalTokens.toLocaleString() + '</div>' +
          '</div>' +
        '</div>';
      }
      
      metricsHtml += '</div></div>';
      const metricsDiv = createElement('div');
      metricsDiv.innerHTML = metricsHtml;
      setContent(usageInfo, metricsDiv.firstChild);
    }

    promptText.addEventListener('input', updatePreview);
    countEl.addEventListener('input', updatePreview);
    
    // Handle schema input with syntax highlighting
    jsonSchemaEl.addEventListener('input', () => {
      updatePreview();
      autoValidateSchema();
    });
    
    // Handle paste in schema editor - clean up formatting
    jsonSchemaEl.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = e.clipboardData.getData('text/plain');
      document.execCommand('insertText', false, text);
    });
    
    temperatureEl.addEventListener('input', updatePreview);
    streamingEl.addEventListener('change', updatePreview);
    providerEl.addEventListener('change', () => {
      updateModelOptions();
    });
    tokenEl.addEventListener('change', () => {
      // Re-fetch models using the provided token (needed in production)
      initModels();
    });
    modelEl.addEventListener('change', updatePreview);

    runBtn.addEventListener('click', run);
    cancelBtn.addEventListener('click', () => {
      if (abortController) abortController.abort();
    });
    loadSampleBtn.addEventListener('click', () => setFromSample());
    copyBtn.addEventListener('click', copyToClipboard);
    
    // Schema helper buttons
    validateSchemaBtn.addEventListener('click', validateJsonSchema);
    clearSchemaBtn.addEventListener('click', clearJsonSchema);
    formatSchemaBtn.addEventListener('click', formatJsonSchema);

    // Initialize models from backend, then load sample
    initModels().then(() => setFromSample());
  </script>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-20">
    <div class="container mx-auto px-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
          <h3 class="text-xl font-semibold mb-4">Documentation</h3>
          <ul class="space-y-2">
            <li><a href="/api/ui" target="_blank" class="text-gray-300 hover:text-white transition-colors">Swagger UI</a></li>
            <li><a href="/api/doc" target="_blank" class="text-gray-300 hover:text-white transition-colors">API Reference</a></li>
            <li><a href="/api/demos" class="text-gray-300 hover:text-white transition-colors">Live Demos</a></li>
            <li><a href="/api/models" class="text-gray-300 hover:text-white transition-colors">Models Guide</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-semibold mb-4">Resources</h3>
          <ul class="space-y-2">
            <li><a href="https://github.com/donvito/ai-backend" class="text-gray-300 hover:text-white transition-colors">GitHub Repository</a></li>
            <li><a href="https://github.com/donvito/ai-backend/issues" class="text-gray-300 hover:text-white transition-colors">Issues & Support</a></li>
            <li><a href="https://github.com/donvito/ai-backend/blob/main/README.md" class="text-gray-300 hover:text-white transition-colors">Setup Guide</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-semibold mb-4">About</h3>
          <p class="text-gray-300 text-sm leading-relaxed">
            Open source AI backend making common AI use cases easily accessible and customizable. 
            100% self-hosted with complete control over your data.
          </p>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
        <p>&copy; 2025 AI Backends. Open source under MIT License.</p>
      </div>
    </div>
  </footer>
</body>
</html>
